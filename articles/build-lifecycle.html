<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Build lifecycle • tic</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- ropensci --><link href="../ropensci.css" rel="stylesheet">
<meta property="og:title" content="Build lifecycle">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a href="https://ropensci.org"><img src="../hexlogo.png" id="hexlogo" alt="rOpenSci"></a>
        <a class="navbar-brand" href="../index.html"><i>tic <small>v0.2.13.9016</small></i></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tic.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/features.html">Feature Overview</a>
    </li>
    <li>
      <a href="../articles/build-lifecycle.html">The CI Build Lifecycle</a>
    </li>
    <li>
      <a href="../articles/tic-travis.html">tic &amp; travis</a>
    </li>
    <li>
      <a href="../articles/advanced.html">Advanced Usage</a>
    </li>
    <li>
      <a href="../articles/deployment.html">Deployment</a>
    </li>
    <li>
      <a href="../articles/custom-steps.html">Custom Steps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ropenscilabs/tic">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Build lifecycle</h1>
                        <h4 class="author">Patrick Schratz, Kirill Müller</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropenscilabs/tic/blob/master/vignettes/build-lifecycle.Rmd"><code>vignettes/build-lifecycle.Rmd</code></a></small>
      <div class="hidden name"><code>build-lifecycle.Rmd</code></div>

    </div>

    
    
<div id="stages" class="section level2">
<h2 class="hasAnchor">
<a href="#stages" class="anchor"></a>Stages</h2>
<p>CI services run builds in stages. Stages are ususally ordered as follows:</p>
<p><img src="img/build-lifecycle.png" style="display: block; margin: auto;"></p>
<p>The <code>after_xxx</code> stages are executed conditionally after their corresponding <code>xxx</code> stage. For example, the <code>after_deploy</code> stage will only be run if the <code>deploy</code> stage was run before. The <code>after_success</code> stage will only be run if the <code>script</code> stage executed successfully, i.e. without error; otherwise <code>after_failure</code> will be run instead.</p>
<p><em>tic</em> also employs an approach based on stages. All action specifications that should be run in each stage are defined in the <code>tic.R</code> file. The steps are specified in an CI-agnostic way using R syntax. A large part of the <code>.travis.yml</code> file consists of glue code and is not meant to be edited anymore.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># DO NOT CHANGE THE CODE BELOW</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">before_install:</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> R -q -e <span class="st">'if (!requireNamespace("remotes", quietly = TRUE)) install.packages("remotes")'</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> R -q -e <span class="st">'if (getRversion() &lt; "3.2" &amp;&amp; !requireNamespace("curl", quietly = TRUE)) install.packages("curl")'</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> <span class="fu">R -q -e 'remotes:</span><span class="at">:install_cran("tic", upgrade = "always"); print(tic::dsl_load()); tic::prepare_all_stages()'</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> <span class="fu">R -q -e 'tic:</span><span class="at">:before_install()'</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="fu">install:</span><span class="at"> R -q -e 'tic::install()'</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="fu">after_install:</span><span class="at"> R -q -e 'tic::after_install()'</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="fu">before_script:</span><span class="at"> R -q -e 'tic::before_script()'</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="fu">script:</span><span class="at"> R -q -e 'tic::script()'</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="fu">after_success:</span><span class="at"> R -q -e 'tic::after_success()'</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="fu">after_failure:</span><span class="at"> R -q -e 'tic::after_failure()'</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="fu">before_deploy:</span><span class="at"> R -q -e 'tic::before_deploy()'</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="fu">deploy:</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  <span class="fu">provider:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  <span class="fu">script:</span><span class="at"> R -q -e 'tic::deploy()'</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">  <span class="fu">on:</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">    <span class="fu">all_branches:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="fu">after_deploy:</span><span class="at"> R -q -e 'tic::after_deploy()'</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="fu">after_script:</span><span class="at"> R -q -e 'tic::after_script()'</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co"># DO NOT CHANGE THE CODE ABOVE</span></a></code></pre></div>
<p>In a nutshell, the workflow is as follows:</p>
<p><code>.travis.yml</code>/<code>appveyor.yml</code> -&gt; <code>tic.R</code> -&gt; commands/steps to execute</p>
<p>An important point to note: The R code declared in <code>tic.R</code> is not meant to be run manually. It also does not trigger a CI build. All commands just define the workflow of the CI build. The workflow can be loaded using <code><a href="../reference/dsl_get.html">dsl_load()</a></code>, this will not run any of the commands defined there. For testing purposes, all stages and steps defined in <code>tic.R</code> can be executed by calling <code><a href="../reference/run_all_stages.html">run_all_stages()</a></code>. This latter emulates a CI build on your local system. See <a href="advanced#troubleshooting-running-tic-locally">Troubleshooting: Running tic locally</a> for more information.</p>
<div id="accessing-a-single-stage" class="section level3">
<h3 class="hasAnchor">
<a href="#accessing-a-single-stage" class="anchor"></a>Accessing a single stage</h3>
<p>The steps which are executed in each stage are specified in <code>tic.R</code>. A stage is executed by calling the respective <em>tic</em> function; for example for stage “deploy” <code><a href="../reference/stages.html">tic::deploy()</a></code>. This function then sources <code>tic.R</code> and collects all steps added to <code>get_stage(&lt;stage name&gt;)</code>, e.g. <code><a href="../reference/dsl.html">get_stage("deploy")</a></code> for the “deploy” stage". Again, remember that the order of the stages is fixed (see <a href="#stages">here</a>), it does not matter in which order you declare the stages in <code>tic.R</code>.</p>
</div>
<div id="details-of-stages" class="section level3">
<h3 class="hasAnchor">
<a href="#details-of-stages" class="anchor"></a>Details of stages</h3>
<div id="the-before_install-install-stages" class="section level4">
<h4 class="hasAnchor">
<a href="#the-before_install-install-stages" class="anchor"></a>The <code>before_install</code> &amp; <code>install</code> stages</h4>
<p>An important stage for <em>tic</em> is the <code>before_install</code> stage. Here, <em>tic</em> itself gets installed and runs <code><a href="../reference/prepare_all_stages.html">prepare_all_stages()</a></code>. This function ensures that all subsequent steps can be executed. Essentially it calls the <code>prepare()</code> method of all steps that were declared in <code>tic.R</code>. For example, the <code>prepare()</code> method of the <code><a href="../reference/step_rcmdcheck.html">step_rcmdcheck()</a></code> step ensures that all dependencies of an R package get installed by calling <code><a href="https://www.rdocumentation.org/packages/remotes/topics/install_deps">remotes::install_deps()</a></code>.</p>
<p>All packages that should be stored in the “cache” of the CI service (so that they do not need to be installed again on every CI build) should be installed during preparation.</p>
</div>
<div id="the-script-stage" class="section level4">
<h4 class="hasAnchor">
<a href="#the-script-stage" class="anchor"></a>The <code>script</code> stage</h4>
<p>The <code>script</code> stage is responsible for executing the important tasks of the CI run: Typically, it runs <code>R CMD check</code> for a package or builds the site for a blogdown site. In this stage all dependencies for a successful run are already installed.</p>
</div>
<div id="the-deploy-stage" class="section level4">
<h4 class="hasAnchor">
<a href="#the-deploy-stage" class="anchor"></a>The <code>deploy</code> stage</h4>
<p>This stage initiates the deployment (e.g., setting up SSH keys) and executes it. If you want to automatically build a <em>pkgdown</em> site, you can do it here. See <a href="deployment.html">the vignette about deployment</a> for more information.</p>
</div>
</div>
</div>
<div id="steps" class="section level2">
<h2 class="hasAnchor">
<a href="#steps" class="anchor"></a>Steps</h2>
<p>Steps are the commands that are executed in each stage. <em>tic</em> uses the <a href="https://magrittr.tidyverse.org/">pipe operator</a> and the <code><a href="../reference/dsl.html">add_step()</a></code> function to chain steps in <code>tic.R</code>, for example</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_build_pkgdown.html">step_build_pkgdown</a></span>())</a></code></pre></div>
<p>In the code example above <code><a href="../reference/step_build_pkgdown.html">step_build_pkgdown()</a></code> is added to the <code>"deploy"</code> stage and subsequently only run in this stage. More steps that should be run in this stage could just by piped after <code><a href="../reference/dsl.html">add_step(step_build_pkgdown())</a></code>. So in summary, steps are usually defined using two nested commands: <code><a href="../reference/dsl.html">add_step()</a></code> and the corresponding step, here <code><a href="../reference/step_build_pkgdown.html">step_build_pkgdown()</a></code>.</p>
<p>Here is a list that shows a rough grouping of the steps into their default stages:</p>
<div id="basic" class="section level4">
<h4 class="hasAnchor">
<a href="#basic" class="anchor"></a>Basic</h4>
<ul>
<li>
<code><a href="../reference/step_hello_world.html">step_hello_world()</a></code>: print “Hello, World!” to the console, helps testing a tic setup</li>
<li>
<code><a href="../reference/step_run_code.html">step_run_code()</a></code>: run arbitrary code, optionally run preparatory code and install dependent packages
<ul>
<li>
<code><a href="../reference/dsl.html">add_step(step_run_code())</a></code> can be abbreviated with <code><a href="../reference/dsl.html">add_code_step()</a></code>
</li>
</ul>
</li>
<li>
<code><a href="../reference/step_write_text_file.html">step_write_text_file()</a></code>: Creates a text file with arbitrary contents</li>
</ul>
</div>
<div id="installation" class="section level4">
<h4 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h4>
<ul>
<li>
<code><a href="../reference/step_install_pkg.html">step_install_cran()</a></code>: Installs one package from CRAN via <code><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages()</a></code>, but only if it’s not already installed.</li>
<li>
<code><a href="../reference/step_install_pkg.html">step_install_github()</a></code>: Installs one or more packages from GitHub via <code><a href="https://www.rdocumentation.org/packages/remotes/topics/install_github">remotes::install_github()</a></code>
</li>
</ul>
</div>
<div id="r-package-specific" class="section level4">
<h4 class="hasAnchor">
<a href="#r-package-specific" class="anchor"></a>R package specific</h4>
<ul>
<li>
<code><a href="../reference/step_build_pkgdown.html">step_build_pkgdown()</a></code>: building package documentation via <a href="https://github.com/r-lib/pkgdown">pkgdown</a>
</li>
<li>
<code><a href="../reference/step_rcmdcheck.html">step_rcmdcheck()</a></code>: run <code>R CMD check</code> via the <em>rcmdcheck</em> package</li>
</ul>
</div>
<div id="deployment" class="section level4">
<h4 class="hasAnchor">
<a href="#deployment" class="anchor"></a>Deployment</h4>
<ul>
<li>
<code>step_install_ssh_key()</code>: make available a private SSH key (which has been added before to your project by <code><a href="../reference/use_tic.html">use_tic()</a></code> or <code><a href="https://www.rdocumentation.org/packages/travis/topics/use_travis_deploy">travis::use_travis_deploy()</a></code>)</li>
<li>
<code><a href="../reference/step_test_ssh.html">step_test_ssh()</a></code>: test the SSH connection to GitHub, helps troubleshooting deploy problems</li>
<li>
<code><a href="../reference/step_setup_ssh.html">step_setup_ssh()</a></code>: Adds to known hosts, installs private key, and tests the connection</li>
<li>
<code><a href="../reference/step_setup_push_deploy.html">step_setup_push_deploy()</a></code>: Clones a repo, initiates author information, and sets up remotes for a subsequent <code><a href="../reference/step_do_push_deploy.html">step_do_push_deploy()</a></code>
</li>
<li>
<code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code>: deploy to GitHub, with arguments:
<ul>
<li>
<code>path</code>: which path to deploy, default: <code>"."</code>
</li>
<li>
<code>branch</code>: which branch to deploy to, default: <code><a href="../reference/ci.html">ci_get_branch()</a></code>
</li>
<li>
<code>orphan</code>: should the branch consist of a single commit that contains all changes (<code>TRUE</code>), or should it be updated incrementally (<code>FALSE</code>, default)
<ul>
<li>You must specify a <code>branch</code> if you set <code>orphan = TRUE</code>
</li>
</ul>
</li>
<li>
<code>remote_url</code>: the remote URL to push to, default: the URL related to the Travis run</li>
<li>
<code>commit_message</code>: the commit message, will by default contain <code>[ci skip]</code> to avoid a loop, and useful information related to the CI run</li>
<li>
<code>commit_paths</code>: Which path(s) to commit. Useful to only commit single files that have changed during the CI run.</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="macros" class="section level2">
<h2 class="hasAnchor">
<a href="#macros" class="anchor"></a>Macros</h2>
<p>Macros in <em>tic</em> are combinations of steps for reoccurring workflows to keep <code>tic.R</code> tidy. When a macro is invoked, it defines several steps, which are added to stages where they fit best. Macros can have parameters to control the behavior of their constituent steps.</p>
<p>The macro function <code><a href="../reference/do_package_checks.html">do_package_checks()</a></code> comes with the most important steps that are needed for R package checking. It adds the following steps:</p>
<ol style="list-style-type: decimal">
<li><p><code><a href="../reference/step_rcmdcheck.html">step_rcmdcheck()</a></code> in the <code>"script"</code> stage, using the <code>error_on</code>, <code>args</code>, <code>build_args</code>, <code>repos</code> and <code>timeout</code> arguments.</p></li>
<li><p>A call to <code><a href="https://www.rdocumentation.org/packages/covr/topics/codecov">covr::codecov()</a></code> in the <code>"after_success"</code> stage.</p></li>
</ol>
<p>If you manually add these steps to stages in <code>tic.R</code> while <code><a href="../reference/do_package_checks.html">do_package_checks()</a></code> is still present, the steps will be executed twice.</p>
<p>Macros do not need to include steps across stages, they can also just cover a sequence of steps of a single stage.</p>
<p>Macros can be distinguished from other functions by their <code>do_</code> prefix. If you have a good use case for a macro, let us know by opening an <a href="https://github.com/ropenscilabs/tic/issues">issue</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#stages">Stages</a></li>
      <li><a href="#steps">Steps</a></li>
      <li><a href="#macros">Macros</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div style="margin-top:-9px">
  <p>tic is a part of <img src="https://github.com/ropensci/logos/raw/master/icon_lettering_color.png" height="40" alt="rOpenSci">. Learn more at <a href="https://ropensci.org">ropensci.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://krlmlr.info">Kirill Müller</a>, <a href="https://pjs-web.de">Patrick Schratz</a>, Mika Braginsky, Karthik Ram, Jeroen Ooms, rOpenSci.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a> &amp; <a href="https://ropensci.github.io/rotemplate/">rotemplate</a>.
  </p>
</div>
      </footer>
</div>

  

  </body>
</html>
