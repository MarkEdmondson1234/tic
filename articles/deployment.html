<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deployment • tic</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- ropensci --><link href="../ropensci.css" rel="stylesheet">
<meta property="og:title" content="Deployment">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-462421-8"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-462421-8');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a href="https://ropensci.org"><img src="../hexlogo.png" id="hexlogo" alt="rOpenSci"></a>
        <a class="navbar-brand" href="../index.html"><i>tic <small>v0.2.13.9019</small></i></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tic.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/features.html">Feature Overview</a>
    </li>
    <li>
      <a href="../articles/build-lifecycle.html">The CI Build Lifecycle</a>
    </li>
    <li>
      <a href="../articles/tic-travis.html">tic &amp; travis</a>
    </li>
    <li>
      <a href="../articles/advanced.html">Advanced Usage</a>
    </li>
    <li>
      <a href="../articles/deployment.html">Deployment</a>
    </li>
    <li>
      <a href="../articles/custom-steps.html">Custom Steps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ropenscilabs/tic">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Deployment</h1>
                        <h4 class="author">Patrick Schratz, Kirill Müller</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropenscilabs/tic/blob/master/vignettes/deployment.Rmd"><code>vignettes/deployment.Rmd</code></a></small>
      <div class="hidden name"><code>deployment.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><em>tic</em> handles deployment as follows:</p>
<ol style="list-style-type: decimal">
<li>
<p>When calling <code><a href="../reference/use_travis_deploy.html">use_travis_deploy()</a></code> (either directly or indirectly by using <code><a href="../reference/use_tic.html">use_tic()</a></code>), a public key is added to GitHub repository under the “Deploy keys” section and the user receives an e-mail:</p>
<p><img src="img/ssh-deploy-key.png" style="display: block; margin: auto;"></p>
</li>
<li>
<p>A private key is encoded in base64 and stored in an environment variable on Travis. During the CI run, <em>tic</em> installs it in the <code>~/.ssh</code> directory so that it can be used for authentication:</p>
<p><img src="img/private-key-travis.png" style="display: block; margin: auto;"></p>
<p>Initiating the deployment via a public-private key pair has the advantage that rights are granted to a single repo only and the setup process can be automated. Additionally, when calling <code><a href="../reference/use_tic.html">use_tic()</a></code> a Personal Access token (PAT) is created (by <code>travis::create_github_pat()</code>) to avoid the errors caused by GitHubs download rate limitations.</p>
</li>
</ol>
</div>
<div id="pkgdown-deployment" class="section level2">
<h2 class="hasAnchor">
<a href="#pkgdown-deployment" class="anchor"></a>pkgdown deployment</h2>
<p><a href="https://github.com/r-lib/pkgdown"><code>pkgdown</code></a> is a R package which builds a documentation wrapper-site of a R package. It collects all the vignettes, function references and metadata information of a package and presents it in an eye-appealing web version. Without a <code>pkgdown</code> site, these package resources need either be collected from various places (GitHub repository, CRAN function reference) or do even require a local installation of the package if vignettes are placed in custom locations. Therefore, it has become a quasi-standard to provide a <em>pkgdown</em> site for a R package. However, it is tedious to update the site on every commit and check whether something has changed. On the other hand, the presence of a <em>pkgdown</em> site is only really valuable to the user if the content reflects the most recent state of the package. <em>tic</em> has the ability to automate the update tasks and having the site reflecting the latest state of the package.</p>
<p>The following example shows how <em>tic</em> deploys a <code>pkgdown</code> site on Travis. In the <code>.travis.yml</code> file:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">before_deploy:</span><span class="at"> R -q -e 'tic::before_deploy()'</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">deploy:</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="fu">provider:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="fu">script:</span><span class="at"> R -q -e 'tic::deploy()'</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="fu">on:</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="fu">all_branches:</span><span class="at"> true</span></a></code></pre></div>
<p>Let’s break down what happens here:</p>
<ol style="list-style-type: decimal">
<li>
<p>Travis executes <code><a href="../reference/stages.html">tic::before_deploy()</a></code> which will search for instructions regarding the <code><a href="../reference/stages.html">before_deploy()</a></code> stage in <code>tic.R</code>.</p>
<p>By default this stage looks like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="cf">if</span> (<span class="kw"><a href="../reference/ci.html">ci_has_env</a></span>(<span class="st">"BUILD_PKGDOWN"</span>)) {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"before_deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_setup_ssh.html">step_setup_ssh</a></span>())</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">}</a></code></pre></div>
<p>This block calls the function <code>step_setup_ ssh()</code> if the environment variable <code>"BUILD_PKGDOWN"</code> is set in the Travis build. That is just an example of an option that can be set to run certain commands (or stages) conditionally (see <a href="advanced.html#running-stages-conditionally">here</a> for more examples). After the prerequisite of setting up an ssh key for the upcoming deployment has been finished,</p>
</li>
<li><p>Travis is told to use a “script” (provider: script) for the deployment (which holds further instructions).</p></li>
<li><p>This “script” is calling <code><a href="../reference/stages.html">tic::deploy()</a></code>.</p></li>
<li>
<p>All this is happening on any branch. (If you want to restrict it to certain branches, you need to set a condition in <code>tic.R</code>.)</p>
<p>What happens now is that <code><a href="../reference/stages.html">tic::deploy()</a></code> again searches in <code>tic.R</code> for the “deploy” stage and then runs whatever is specified there.</p>
<p>With the default template of <code>tic.R</code>, the following will be executed:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_build_pkgdown.html">step_build_pkgdown</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_push_deploy.html">step_push_deploy</a></span>())</a></code></pre></div>
<p>First, <code><a href="../reference/step_build_pkgdown.html">step_build_pkgdown()</a></code> will build your <em>pkgdown</em> site and afterwards (note the <code>pipe</code> operator chaining the commands), <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code> takes care pushing the results to the repo. By default this will be the <code>docs/</code> directory of the <code>master</code> branch.</p>
</li>
</ol>
<div id="deploying-to-docs-master-or-gh-pages-branch" class="section level3">
<h3 class="hasAnchor">
<a href="#deploying-to-docs-master-or-gh-pages-branch" class="anchor"></a>Deploying to docs/ (master) or gh-pages branch</h3>
<div id="master-branch-deployment" class="section level4">
<h4 class="hasAnchor">
<a href="#master-branch-deployment" class="anchor"></a>master branch deployment</h4>
<p>By default the deployment is done to the <code>docs/</code> directory of the <code>master</code> branch. This has the following advantages:</p>
<ul>
<li>You can have per-branch versions of your <em>pkgdown</em> site</li>
<li>Per-branch versions enable the possibility to have preview for pull requests via <a href="https://www.netlify.com/" class="uri">https://www.netlify.com/</a>
</li>
</ul>
<p>A disadvantage is that the <code>master</code> branch will be cluttered by automatic commits triggered by Travis that push the changes of the <em>pkgdown</em> site to the <code>master</code> branch.</p>
</div>
<div id="gh-pages-branch-deployment" class="section level4">
<h4 class="hasAnchor">
<a href="#gh-pages-branch-deployment" class="anchor"></a>gh-pages branch deployment</h4>
<p>You can optionally set the deployment branch to <code>gh-pages</code> and then change the branch serving your site in the GitHub repo settings (change it to <code>gh-pages</code>). This option has the advantage</p>
<ul>
<li>to not have all the automatic commits from Travis in the <code>master</code> branch -&gt; the <em>pkgdown</em> site will be “silently” updated in the background in the <code>gh-pages</code> branch.</li>
</ul>
<p>A disadvantage is that you cannot have per-branch versions of your site and hence no pull request previews of the site.</p>
<p>To use this option with <em>tic</em>, specify <code>branch = "gh-pages", path = "docs"</code> in <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code>. As the site serving in this setting will use the root of the branch, the <code>gh-pages</code> branch will only consist of the public <em>pkgdown</em> files used to serve the site.</p>
</div>
</div>
</div>
<div id="conditional-deployment" class="section level2">
<h2 class="hasAnchor">
<a href="#conditional-deployment" class="anchor"></a>Conditional deployment</h2>
<p>If you are running a <a href="https://docs.travis-ci.com/user/build-matrix/">build matrix</a> or <a href="https://docs.travis-ci.com/user/build-stages/">build stages</a> on Travis, you want to run certain tasks only once during a build. The creation of a <em>pkgdown</em> site is a common task which applies to this.</p>
<p>Another situation in which conditioning comes in handy is when you want to deploy multiple files in different stages. You can restrict on which stage/job a task is executed with the help of environment variables.</p>
<p><em>tic</em> can make use of implicit set environment variables of the build and additional ones added by the user. In the following we show a “build stage” example on Travis using the custom env variable <code>"BUILD_PKGDOWN"</code>:</p>
<p><code>.travis.yml</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="fu">jobs:</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="fu">include:</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> <span class="fu">stage:</span><span class="at"> stage1</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">      <span class="fu">env:</span><span class="at"> BUILD_PKGDOWN=TRUE</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">      <span class="fu">before_install:</span><span class="at"> </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> R -q -e <span class="st">'install.packages("remotes")'</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> <span class="fu">R -q -e 'remotes:</span><span class="at">:install_github("ropenscilabs/tic")'</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Arithmetic">-</a></span> <span class="fu">R -q -e 'tic:</span><span class="at">:prepare_all_stages(); tic::before_install()'</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extract">[</a></span>...<span class="kw">]</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">      <span class="fu">deploy:</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">        <span class="fu">provider:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">        <span class="fu">script:</span><span class="at"> R -q -e 'tic::deploy()'</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">        <span class="fu">on:</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">          <span class="fu">all_branches:</span><span class="at"> true</span></a></code></pre></div>
<p><code>tic.R</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getenv">Sys.getenv</a></span>(<span class="st">"id_rsa"</span>) <span class="op">!=</span><span class="st"> ""</span>) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"before_deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_setup_ssh.html">step_setup_ssh</a></span>())</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Logic">isTRUE</a></span>(<span class="st">"BUILD_PKGDOWN"</span>)) {</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="st">    </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_build_pkgdown.html">step_build_pkgdown</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="st">    </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_push_deploy.html">step_push_deploy</a></span>())</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">}</a></code></pre></div>
</div>
<div id="committing-single-files" class="section level2">
<h2 class="hasAnchor">
<a href="#committing-single-files" class="anchor"></a>Committing single files</h2>
<p>The <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code> function has the ability to restrict the files that are committed and pushed. This can be very useful for conditionally pushing documentation files like <code>NEWS</code> or <code>man/</code> and <code>NAMESPACE</code> if these are automatically created via Travis.</p>
<p>In the following example, these files are created/updated by calling <code><a href="https://www.rdocumentation.org/packages/devtools/topics/document">devtools::document()</a></code>. The <code>commit_paths</code> argument in <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code> decides which files are committed and pushed:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"before_deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">    </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_setup_ssh.html">step_setup_ssh</a></span>())</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw"><a href="../reference/dsl.html">get_stage</a></span>(<span class="st">"deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/dsl.html">add_code_step</a></span>(devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/document">document</a></span>(<span class="dt">roclets =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"rd"</span>, <span class="st">"collate"</span>, <span class="st">"namespace"</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="../reference/dsl.html">add_step</a></span>(<span class="kw"><a href="../reference/step_push_deploy.html">step_push_deploy</a></span>(<span class="dt">commit_paths =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"NAMESPACE"</span>, <span class="st">"man/*"</span>)))</a></code></pre></div>
<p>Applying this idea depends on your overall R package development strategy: Commit files like <code>/man/</code> and <code>NAMESPACE</code> directly or let them be created by Travis? An example project that uses the latter strategy is <a href="https://github.com/mlr-org/mlrng/blob/master/tic.R">mlr</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#pkgdown-deployment">pkgdown deployment</a></li>
      <li><a href="#conditional-deployment">Conditional deployment</a></li>
      <li><a href="#committing-single-files">Committing single files</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div style="margin-top:-9px">
  <p>tic is a part of <img src="https://github.com/ropensci/logos/raw/master/icon_lettering_color.png" height="40" alt="rOpenSci">. Learn more at <a href="https://ropensci.org">ropensci.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://krlmlr.info">Kirill Müller</a>, <a href="https://pjs-web.de">Patrick Schratz</a>, Mika Braginsky, Karthik Ram, Jeroen Ooms, rOpenSci.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a> &amp; <a href="https://docs.ropensci.org/rotemplate/">rotemplate</a>.
  </p>
</div>
      </footer>
</div>

  

  </body>
</html>
