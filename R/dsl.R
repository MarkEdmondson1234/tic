#' @import backports
NULL

#' @importFrom utils packageName
load_from_file_ <- function(path = "tic.R", ..., mtime = file.mtime(path)) {
  dsl <- create_dsl(envir = asNamespace(packageName()))
  source(path, local = dsl)
  dsl$get_stages()
}

#' Process a tic.R file
#'
#' Return a named list of stages generated by evaluating a file that uses the
#' tic [DSL].
#' The file is read and evaluated only once, unless its modification timestamp
#' changes.
#'
#' @param path `[string]`\cr
#'   Path to the stage definition file, default: `"tic.R"`.
#' @param ... ignored
#' @param mtime `[POSIXt]`\cr
#'   For internal use, to detect changes to this file.
#'
#' @export
load_from_file <- memoise::memoise(load_from_file_)

#' tic's domain-specific language
#'
#' Functions to define stages and their constitutent
#' steps.
#'
#' @name DSL
NULL

#' @description
#' `get_stage()` returns a Stage object for a stage given by name.
#' This function only works when called by [load_from_file()].
#'
#' @param name `[string]`\cr
#'   The name for the stage.
#' @param private
#'   For internal use.
#' @rdname DSL
#' @export
get_stage <- function(name, private = NULL) {
  stage <- private$stages[[name]]
  if (is.null(stage)) {
    stop("Unknown stage ", name, ".", call. = FALSE)
  }
  stage
}

#' @description
#' `add_step()` adds a step to a stage, see [step_hello_world()]
#' and the links therein for available steps.
#'
#' @param stage `[Stage]`\cr
#'   A Stage object as returned by `get_stage()`.
#' @param step `[function]`\cr
#'   A function that constructs a Step object, such as [step_hello_world()].
#' @rdname DSL
#' @export
add_step <- function(stage, step) {
  stage$add_step(step, deparse(substitute(step), width.cutoff = 500, nlines = 1))
}

#' @description
#' `add_code_step()` is a shortcut for `add_step(step_run_code(...))`.
#'
#' @export
#' @inheritParams step_run_code
#' @rdname DSL
add_code_step <- function(stage, call, prepare_call = NULL) {
  call <- substitute(call)
  prepare_call <- substitute(prepare_call)
  step <- RunCode$new(.call = call, .prepare_call = prepare_call)
  stage$add_step(
    step,
    paste0(
      "step_run_code(",
      deparse(call, width.cutoff = 500, nlines = 1),
      if (!is.null(prepare_call)) {
        paste0(
          ", prepare_call = ",
          deparse(prepare_call, width.cutoff = 500, nlines = 1))
      },
      ")"
    )
  )
}

#' @description
#' `add_package_checks()` adds default steps related to package checks
#' to the `"before_install"`, `"install"`, `"script"` and `"after_success"`
#' stages:
#'
#' @inheritParams step_rcmdcheck
#' @rdname DSL
#' @export
add_package_checks <- function(warnings_are_errors = TRUE,
                               notes_are_errors = FALSE,
                               args = c("--no-manual", "--as_cran"),
                               private = NULL) {
  #' @description
  #' 1. A call to [utils::update.packages()] with `ask = FALSE` in the
  #'    `"before_install"` stage (only for non-interactive CIs)
  if (!ci()$is_interactive()) {
    add_code_step(get_stage("before_install", private = private), utils::update.packages(ask = FALSE))
  }

  #' 1. A call to [remotes::install_deps()] with `dependencies = TRUE`
  #'    in the `"install"` stage
  add_code_step(get_stage("install", private = private), remotes::install_deps(dependencies = TRUE))

  #' 1. A [step_rcmdcheck()] in the `"script"` stage, using the
  #'    `warnings_are_errors`, `notes_are_errors` and `args` arguments
  add_step(
    get_stage("script", private = private),
    step_rcmdcheck(
      warnings_are_errors = warnings_are_errors,
      notes_are_errors = notes_are_errors,
      args = args
    )
  )

  #' 1. A call to [covr::codecov()] in the `"after_success"` stage
  add_code_step(get_stage("after_success", private = private), covr::codecov(quiet = FALSE))
}

#' @importFrom magrittr %>%
DSL <- R6Class(
  "DSL",

  public = list(
    initialize = function() {
      stage_names <- c(
        "before_install",
        "install",
        "after_install",
        "before_script",
        "script",
        "after_success",
        "after_failure",
        "before_deploy",
        "deploy",
        "after_deploy",
        "after_script"
      )

      private$stages <- lapply(stats::setNames(nm = stage_names), Stage$new)
    },

    get_stage = function(name) {
      get_stage(name, private)
    },

    get_stages = function() {
      private$stages
    },

    add_step = function(stage, step) {
      add_step(stage, step)
    },

    # NSE!
    add_code_step = add_code_step,

    add_package_checks = function(warnings_are_errors = TRUE,
                                  notes_are_errors = FALSE,
                                  args = "--no-manual") {
      add_package_checks(
        warnings_are_errors = warnings_are_errors,
        notes_are_errors = notes_are_errors,
        args = args,
        private = private
      )
    },

    add_task = function(stage, run, check = NULL, prepare = NULL) {
      stage$add_task(run, check, prepare)
    }
  ),

  private = list(
    stages = NULL
  )
)

create_dsl <- function(envir = parent.frame()) {
  dsl <- DSL$new()
  parent.env(dsl) <- envir
  dsl
}
