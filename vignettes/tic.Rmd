---
title: "Getting started with CI for R"
author: "Patrick Schratz, Kirill Müller"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Kirill Müller}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Prerequisites

If you are unfamiliar with the term Continuous Integration (CI), we highly recommend to read the following resources:

- https://ropensci.github.io/dev_guide/ci.html
- https://juliasilge.com/blog/beginners-guide-to-travis/
- http://mahugh.com/2016/09/02/travis-ci-for-test-automation/

The advantages of using `tic` for R-related CI workflows are: 

- CI-agnostic workflow definitions (in R!)
- Simplified deployment (e.g. automatic deployment of a `pkgdown` site for a R package)
- Improved package checking via [rcmdcheck](https://github.com/r-lib/rcmdcheck)
- Robust caching approach

A more comprehensive summary of all advantages can be found in the [advantages](advantages.html) vignette.

# Initialization

The easiest way to use `tic` for CI services is to call `usethis::use_ci()`.
This will create templates for both "Travis CI" and "Appveyor" and initialize all the required authentication steps for deployment.
During the process, browser pages will open app ensuring that all permissions are set correctly and all apps are authorized.
Also a Personal Access Token (PAT) will be created for Travis, using a private Github PAT variable.
Read [here](https://itsalocke.com/blog/using-travis-make-sure-you-use-a-github-pat/) why this is important.
The PAT creation cannot be fully automated as some input from the user on Github is required when creating the PAT.

First, authentication with Travis (a browser window opens) and Github is initiated (another browser window opens).
Also, the repo is actived on Travis.

```{r, eval = FALSE}
usethis::use_ci()
✔ Setting active project to '/home/pjs/git/tic.package'
✔ GitHub is already initialized
Authenticating with GitHub
Waiting for authentication in browser...
Press Esc/Ctrl + C to abort
Authentication complete.
Authenticating with Travis
Authenticating with GitHub
Waiting for authentication in browser...
Press Esc/Ctrl + C to abort
Authentication complete.
Finished activating repo pat-s/tic.package on Travis CI.
```

Next, you will be asked if the current `.travis.yml` should be replaced with the template from `tic` (if one exists).
Otherwise, the template is added without asking.

```{r, eval = FALSE}
Overwrite pre-existing file '.travis.yml'?
1: Absolutely not
2: Nope
3: Yeah
```

The same is done for Appveyor.

```{r, eval = FALSE}
Selection: 3
✔ Writing '.travis.yml'
Overwrite pre-existing file 'appveyor.yml'?
1: Yeah
2: Nope
3: No way

Selection: 1
✔ Writing 'appveyor.yml'
```

And also for the `tic.R` file.
Additionally, its added to `.Rbuildignore` to not interfer with the package building.

```{r, eval = FALSE}
Overwrite tic.R? 

1: Yes
2: No

Selection: 1
Added tic.R from template.
✔ Adding '^tic\\.R$' to '.Rbuildignore'
```

Next, the `private deploy key for Travis is added to the Github repo.
This is needed to give Travis permissions to deploy into the Github repo.

```{r, eval = FALSE}
Authenticating with GitHub
Waiting for authentication in browser...
Press Esc/Ctrl + C to abort
Authentication complete.
Finished adding deploy keys on GitHub for repo pat-s/tic.package.
Successfully added public deploy key 'travis+tic for pat-s/tic.package' to GitHub for 
pat-s/tic.package. You should receive a confirmation e-mail from GitHub. Delete the 
key in the repository's settings when you no longer need it.
```

Besides the private deploy key, also the public deploy key need to be added as an environment variable to Travis.
As its a SSH key, its named `id_rsa` by default.

```{r, eval = FALSE}
Finished adding private environment variable id_rsa to pat-s/tic.package on Travis CI.
Successfully added private deploy key to pat-s/tic.package as secure environment variable
id_rsa to Travis CI.
```

Last, a PAT is created to avoid the download limit of Github packages on Travis.
You now see two environment variables in your setting on Travis CI: `GITHUB_PAT` and `id_rsa`.

```{r, eval = FALSE}
Create a personal access token, make sure that you are signed in as the correct user. 
The suggested description 'travis+tic for pat-s/tic.package' has been copied to the 
clipboard. If you use this token only to avoid GitHubs rate limit, you can leave 
all scopes unchecked. Then, copy the new token to the clipboard, it will be 
detected and applied automatically. Please visit
  https://github.com/settings/tokens/new
A browser window will be opened.
Waiting for PAT to appear on the clipboard.
Detected PAT, clearing clipboard.
Finished adding private environment variable GITHUB_PAT to pat-s/tic.package on Travis CI.
```

All this functionality is integrated in the [`usethis`](http://usethis.r-lib.org/) package because it contains various other useful `use_*` functions that simplify R (package) development.
However, the heavy lifting in the background is actually done by the R packages `travis` and `tic`. 
See [here](tic-usethis-travis.html) for more detailed information on how `tic`, `travis` and `usethis` work together.

# Explanation of the basic template

After having called `usethis::use_ci()` you will find a `.travis.yml`, `appveyor.yml` and a `tic.R` file in your repo.
Usually you do not need to touch `appveyor.yml` and `.travis.yml` anymore.
All build customizations are done in `tic.R` and apply to both services.
If you want more information about the whole build lifecycle, check the [Build lifecycle](build-lifecycle.html) vignette.

The basic `tic.R` template looks as follows:

```r
add_package_checks(warnings_are_errors = (getRversion() >= "3.2"))

if (Sys.getenv("BUILD_PKGDOWN") != "") {
  get_stage("before_deploy") %>%
    add_step(step_setup_ssh())

  get_stage("deploy") %>%
    add_step(step_build_pkgdown()) %>% 
    add_step(step_push_deploy())
}
```

Let's break done what happens here:

```r
add_package_checks(warnings_are_errors = (getRversion() >= "3.2"))
```

Is a macro which adds essential steps to various stages of a CI run. 
For example, it adds `step_rcmdcheck()` to the "script" stage. 
Check `?add_package_checks()` to see a list of all added steps by this convenience function.

```r
if (Sys.getenv("BUILD_PKGDOWN") != "") { }
```

This line conditions the contents of the block inside the braces `{ }` on the existence of the environment variable `"BUILD_PKGDOWN"`.
The env variable is set in [`.travis.yml`](https://github.com/ropenscilabs/tic/blob/d3c9ffab7e42ef4bf0a3113337c42dbaf592146c/.travis.yml#L45-L47), conditioned on the job that runs on the current R-release version:

```yml
- r: 3.3
- r: 3.4
- r: release
  env:
    - BUILD_PKGDOWN=true
```

If the `if`-condition evaluates to `TRUE`, the following is executed:
First, `step_setup_ssh()` sets up the SSH connection needed for deployment.

```r
get_stage("before_deploy") %>%
  add_step(step_setup_ssh())
```

Then, in the "deploy" stage of the CI run, function `step_build_pkgdown()` will build a [`pkgdown`](http://pkgdown.r-lib.org/) site if the project is an R package, and the `step_push_deploy()` step will push the updated files (if any) to Git.

```r
get_stage("deploy") %>%
  add_step(step_build_pkgdown()) %>% 
  add_step(step_push_deploy())
```

# Examples projects

`tic` can be used for various R projects:

- [tic.package](https://github.com/krlmlr/tic.package): R packages
- [tic.blogdown](https://github.com/krlmlr/tic.blogdown): Blogs with [_blogdown_](https://bookdown.org/yihui/blogdown/)
- [ŧic.bookdown](https://github.com/krlmlr/tic.bookdown): Books with [_bookdown_](https://bookdown.org/)
- [tic.drat](https://github.com/krlmlr/tic.drat): CRAN-like package repositories with [_drat_](http://dirk.eddelbuettel.com/code/drat.html)
- [tic.website](https://github.com/krlmlr/tic.website): Websites with [_rmarkdown_](https://rmarkdown.rstudio.com/)
- [tic.figshare](https://github.com/krlmlr/tic.figshare): Deploying artifacts to [figshare](https://figshare.com/) (work in progress).

As a show case, we explain a "blogdown" project in more detail.
[`blogdown`](https://bookdown.org/yihui/blogdown/) is an R package for publishing websites.
Under the hood, it uses the framework [HUGO](https://gohugo.io/) which gets installed by the respective `tic.R` [template](https://github.com/krlmlr/tic.blogdown/blob/975aedd43fec1dd55e8348eccfca2c7c5f663006/tic.R#L5) in the "install" section:

```r
get_stage("install") %>%
  add_code_step(blogdown::install_hugo(), 
                prepare_call = remotes::install_github("rstudio/blogdown"))
```

Then the website is built and deployed.
The `blogdown::build_site()` function for websites is the equivalent to `pkgdown::build_site()` for R packages.

```r
get_stage("deploy") %>%
    add_code_step(blogdown::build_site()) %>%
    add_step(step_push_deploy())
```

Steps and stages differ between projects (e.g. between a "blogdown" website and a "package").
`tic` is smart enough to detect your project automatically when calling `usethis::use_ci()` and will add the correct template.

**Note:** Currently, publishing to https://figshare.com/ doesn't work.
Also, publishing to https://zenodo.org/ is work in progress.

# Advanced

The advanced usage of `tic` is described in more detail in the [Advanced Usage](advanced.html) article:

- [Options for `pkgdown` deployment](advanced.html#pkgdown-deployment) 
- [Using Travis CI Meta-information](advanced.html#using-travis-ci-meta-information)
- [Troubleshooting: Running `tic` locally](advanced.html#troubleshooting-running-tic-locally)
- [Troubleshooting: Enter into the Travis build](advanced.html#troubleshooting-running-tic-locally)
- [Writing custom steps](custom-steps.html)

The build lifecycle when using `tic` is explained in the [Build lifecycle](build-lifecycle.html) article.
